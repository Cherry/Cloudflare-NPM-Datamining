<div class="mb2 gray5">12 min read</div><img class="mr2" src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/28gU1SRoYvxSYYqcc8y4Jj/51403d2e79361c5de72ec1ce8fec6eb6/image3.png" alt="">
<div class="post-content lh-copy gray1">
	<p>With <a href="https://www.cloudflare.com/application-services/products/waiting-room/?cf_target_id=80139F59125DEFCA9DD4FAF8C6C73D4F"><u>Cloudflare Waiting Room,</u></a> you can safeguard your site from traffic surges by placing visitors in a customizable, virtual queue. Previously, many site visitors waited in the queue alongside bots, only to find themselves competing for inventory once in the application. This competition is inherently unfair, as bots are much faster and more efficient than humans. As a result, humans inevitably lose out in these high-demand situations, unable to secure inventory before bots sweep it all up. This creates a frustrating experience for real customers, who feel powerless against the speed and automation of bots, leading to a diminished experience overall. Those days are over! Today, we are thrilled to announce the launch of two Waiting Room solutions that significantly improve the visitor experience.</p>
	<p>Now, <b>all</b> Waiting Room customers can add an invisible <a href="https://www.cloudflare.com/application-services/products/turnstile/?cf_history_state=%7B%22guid%22%3A%22C255D9FF78CD46CDA4F76812EA68C350%22%2C%22historyId%22%3A21%2C%22targetId%22%3A%222734F402BB1100617F807DE827E8036D%22%7D"><u>Turnstile </u></a>challenge to their queueing page, robustly challenging traffic and gathering analytics on bot activity within their queue. With Advanced Waiting Rooms, you can select between an <a href="https://developers.cloudflare.com/turnstile/concepts/widget/#widget-types"><u>invisible, managed, or non-interactive widget mode</u></a>. But, we won’t just block these bots! Instead, traffic with definite bot signals that have failed the Turnstile challenge can be sent to an Infinite Queue, a completely customizable page that mimics a real user experience. This prolongs the time it takes bots to realize they have not actually joined the queue, wasting their resources without impacting real users. This feature not only protects your site against bots, but also reduces wait times and protects inventory by ensuring the queue only consists of genuine users. To offset the environmental impact of wasting bot resources, we’re contributing to a <a href="https://blog.cloudflare.com/cleaning-up-bad-bots/#planting-trees"><u>tree planting initiative</u></a>, helping to reduce the carbon footprint of inefficient bots.&nbsp;</p>
	<p>The second solution we have launched to improve the visitor experience is Session Revocation, which allows you to end a user’s session based on an action, dynamically opening up spots and admitting users from the queue. This new capability allows you to integrate Waiting Room more seamlessly with your customer journey, resulting in increased throughput, decreased wait times, and increased fairness by giving more users the opportunity to make it through the queue during high demand events.&nbsp;</p>
	<p>This feature has proven to be extremely impactful for our customers, including a large online retailer that frequently has high-demand limited edition product drops. A common challenge in this space is maximizing the number of customers who can make a purchase during a limited-time event, all while maintaining a fair and efficient system for everyone involved. Previously, this customer had to limit their users to only one item in the cart and force them to wait for a period of time after each checkout before allowing them to rejoin the queue. This led to an awkward experience for end users, longer wait times, and reduced site throughput. With session revocation, this online retailer can now end the user’s session immediately after a purchase is complete, placing the user back in the queue if applicable, <b>without </b>being forced to wait for a preset timeout period. This significantly improves the end user experience by reducing unnecessary wait times and streamlining the purchase process.</p>
	<p>Let’s deep dive into these two capabilities and how they improve the overall user experience.</p>
	<div class="flex anchor relative">
		<h3 id="how-bots-impact-the-waiting-room-user-experience">How bots impact the Waiting Room user experience&nbsp;</h3>
		<a href="https://blog.cloudflare.com/#how-bots-impact-the-waiting-room-user-experience" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>Waiting Room is often used to protect sites from being overwhelmed by traffic surges during high demand online events. These high demand events, such as ticket or e-commerce product sales, attract both a deluge of genuine users, and sophisticated bots, such as scalper bots. This type of bot traffic is unique, as they can complete the checkout process or user journey much quicker than normal human traffic. Bots in the queue negatively affect the user experience by increasing wait times, as they often occupy multiple spots. Additionally, their behavior can exacerbate the issue — if they don't handle cookies properly, they fail to take their spot in the application when their turn comes, further preventing the queue from progressing smoothly. Once past the queue, bots can also contribute to inventory hoarding, as they often reserve or consume large quantities of stock without genuine intent to purchase. An <a href="https://www.nbcnews.com/tech/video-games/good-luck-finding-playstation-5-walmart-retailers-battle-fast-buying-b-rcna193"><u>example</u></a> of this is the PlayStation 5’s launch in November 2020. Due to high demand and production limitations during the COVID-19 pandemic, scalper bots bought up stock quickly, making it difficult for average consumers to purchase the console at retail prices. This led to extreme frustration for retailers and consumers as these bots drove the prices up significantly.&nbsp;</p>
	<div class="flex anchor relative">
		<h3 id="quantifying-bot-traffic-to-waiting-room-with-an-invisible-turnstile-challenge">Quantifying bot traffic to Waiting Room with an invisible Turnstile challenge</h3>
		<a href="https://blog.cloudflare.com/#quantifying-bot-traffic-to-waiting-room-with-an-invisible-turnstile-challenge" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>Waiting Room customers have long been curious about the nature of large traffic spikes. Historically, <a href="https://developers.cloudflare.com/bots/concepts/bot-score"><u>bot scores</u></a> and <a href="https://developers.cloudflare.com/waf/reference/cloudflare-challenges"><u>managed challenges</u></a> have been the primary methods of collecting this data and acting on it. While these can provide some insight into the distribution of traffic, the Turnstile invisible challenge gives us the ability to actively interrogate the browser, providing the most complete set of data on whether that browser is being operated by a human or a bot.&nbsp;</p>
	<p>To start quantifying bot traffic to waiting rooms, we have added an invisible Turnstile challenge to all basic rooms. With the purchase of an Advanced Waiting Room, customers can select between invisible, managed, or non-interactive widget modes. This Turnstile team <a href="https://blog.cloudflare.com/guide-to-cloudflare-pages-and-turnstile-plugin/?_gl=1*1fb6wb0*_gcl_au*Mzg4NDc3ODA1LjE3MzY3ODc4NjI.*_ga*MTI5NDczNzY0Ny4xNzM0NzEyNjMx*_ga_SQCRB0TXZW*MTczODYwNDE5Ny4xNC4xLjE3Mzg2MDQ4MDIuMjUuMC4w%2F#step-2-embed-turnstile-widget"><u>blog post</u></a> has more details on the different widget modes.&nbsp;&nbsp;</p>
	<p>Waiting Room’s integration with Turnstile aims to protect your site with minimal impact to the user experience by placing a Turnstile challenge on your waiting room’s queuing page. Unlike a standard WAF challenge, the Waiting Room Turnstile challenge is presented only when the waiting room is queuing. This way, users won’t face any interruptions once they are past the queue and into the application.&nbsp;</p>
	<figure class="kg-card kg-image-card">
		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/3GLXMvDBi5jBTs9rxQXBin/e75077558061fd5afe0a0244d807814c/image8.png" alt="" class="kg-image" width="882" height="400" loading="lazy">
	</figure>
	<p><sup><i>With an advanced waiting room, you can configure the type of Turnstile challenge from the Cloudflare dashboard and API.</i></sup></p>
	<p>From the analytics we’ve gathered with the invisible Turnstile challenge on all basic waiting rooms, we’ve been able to determine that many large traffic spikes come from user agents that don’t even attempt to run the challenge, leaving it unsolved. In other words, we send the challenge widget in the HTML for the queuing page, but sometimes those challenges never get completed. By subtracting the number of times we see solved challenges from the total number of times we send challenges, we can get a count of requests that are likely from unsophisticated bots. These requests are reported to Waiting Room Analytics as “Likely Bots.” We’ve seen small businesses with low baseline traffic hit with tens of thousands of such requests (or more) in a short period of time. When a large influx of non-human traffic like this comes in, every visitor to the website ends up queued in a waiting room, not just the bots.</p>
	<p>These bots could be any software that simply sends out HTTP requests. This data can help determine whether a traffic spike and subsequent queueing is coming from real human users, or a bunch of simple bots that don’t even bother to run JavaScript.</p>
	<p>With the Turnstile integration, we are also catching sophisticated bots. While many of the bots we see don’t attempt to run the challenge, there are a few that do. Detecting these bots is more difficult than detecting simple bots that don’t run JavaScript. The Turnstile widget runs a series of checks against the browser to find evidence that a browser isn’t being operated by a human, and is instead being driven by something like <a href="https://www.selenium.dev"><u>Selenium</u></a>. If Turnstile isn’t able to determine that the browser is being operated by a human, we count that as a failed challenge and report those users to Waiting Room Analytics as “Bots,” since we are quite confident that these users are not human.</p>
	<p>About 1 in 20 “users” that run the challenge end up not passing. Just like the previously mentioned unsophisticated bots, these more sophisticated bots inflate the size of the queue, making it more difficult for real humans to make it through to your website.</p>
	<p>The remaining 19 in 20 “users” that successfully pass the challenge are counted in Waiting Room Analytics as “Likely Humans.”</p>
	<p>These new metrics related to Turnstile challenge outcomes are available in your Waiting Room Analytics dashboard and the <a href="https://developers.cloudflare.com/analytics/graphql-api"><u>analytics GraphQL API</u></a>, so you can see the distribution of bot to human traffic in your waiting room. Once you know what your traffic looks like, the real question is: what can you do about it?</p>
	<figure class="kg-card kg-image-card">
		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/1RVNiQAX4OE87L0H7ByyWb/b6eadb0f348d7ce711d138862b778117/image2.png" alt="" class="kg-image" width="1027" height="639" loading="lazy">
	</figure>
	<p><sup><i>View the distribution of traffic and challenges issued in Waiting Room Analytics</i></sup></p>
	<div class="flex anchor relative">
		<h3 id="new-infinite-queue-feature">New Infinite Queue feature</h3>
		<a href="https://blog.cloudflare.com/#new-infinite-queue-feature" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>Beyond logging your Turnstile challenge outcomes, Advanced Waiting Room customers have the option to select the Infinite Queue feature. With this feature, all traffic that fails the Turnstile challenge, such as a bot, will be sent to an Infinite Queue page. The Infinite Queue matches the normal queuing experience, prolonging the time it takes the bot to recognize they are being blocked and effectively consuming their resources. While the Infinite Queue will have the same look and feel as the Waiting Room page, the bot is not actually a part of the real queue.&nbsp;</p>
	<p>With the infinite Queue enabled, all traffic will have to pass the challenge to enter the real queue. By blocking bots from joining the queue, we will reduce wait times for humans and prevent bots from using up server resources during a traffic spike.</p>
	<figure class="kg-card kg-image-card">
		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/55Du8cmC3JfX4FrhL9KWIM/b273bb820290aad6997494551c0b49ac/image9.png" alt="" class="kg-image" width="837" height="171" loading="lazy">
	</figure>
	<p><sup><i>Enable the Infinite Queue option through the Cloudflare dashboard or API.</i></sup></p>
	<p>Bots will be none the wiser, wasting their time and resources waiting in an infinite queue that will never get them to where they’re trying to go.</p>
	<p>We keep track of the traffic hitting the infinite queue, counting the number of times they refresh their queuing page in Waiting Room Analytics. This appears as the “infinite queue refreshes” count in the analytics dash and GraphQL API. This metric gives you a good idea of the amount of time these bots have wasted trying to reach your website.</p>
	<div class="flex anchor relative">
		<h3 id="how-waiting-room-integrates-with-turnstile">How Waiting Room integrates with Turnstile</h3>
		<a href="https://blog.cloudflare.com/#how-waiting-room-integrates-with-turnstile" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>Turnstile is a powerful and versatile product that anyone, Cloudflare and others alike, can use to build systems to thwart bot traffic. Waiting Room integrates Turnstile the same as any other Turnstile user.</p>
	<pre class="language-Rust"><code class="language-Rust">&lt;!DOCTYPE html&gt;
&lt;html&gt;
	&lt;head&gt;
		&lt;title&gt;Waiting Room&lt;/title&gt;
	&lt;/head&gt;
	&lt;body&gt;
		&lt;h1&gt;You are currently in the queue.&lt;/h1&gt;
		{{#waitTimeKnown}}
			&lt;h2&gt;Your estimated wait time is {{waitTimeFormatted}}.&lt;/h2&gt;
		{{/waitTimeKnown}}
		{{^waitTimeKnown}}
			&lt;h2&gt;Your estimated wait time is unknown.&lt;/h2&gt;
		{{/waitTimeKnown}}
		{{#turnstile}}
			&lt;!-- for a managed (and potentially interactive) challenge, you may want to instruct the user to complete the challenge --&gt;
			&lt;p&gt;Please complete this challenge so we know you're a human:&lt;/p&gt;
			{{{turnstile}}} &lt;!-- include the turnstile widget --&gt;
		{{/turnstile}}
	&lt;/body&gt;
&lt;/html&gt;</code></pre>
	<p><sup><i>The Turnstile widget can be embedded in custom queuing page templates by including the </i></sup><code><sup><i>{{{turnstile}}}</i></sup></code><sup><i> variable.</i></sup></p>
	<pre class="language-Rust"><code class="language-Rust">&lt;!DOCTYPE html&gt;
&lt;html&gt;
	&lt;head&gt;
		&lt;title&gt;Waiting Room&lt;/title&gt;
	&lt;/head&gt;
	&lt;body&gt;
		{{#turnstile}}
			&lt;h1&gt;This website is currently using a waiting room.&lt;/h1&gt;
			&lt;p&gt;We use a Turnstile challenge to ensure you aren't waiting in line behind bots. Complete this challenge to enter the queue.&lt;/p&gt;
			{{{turnstile}}} &lt;!-- include the turnstile widget --&gt;
		{{/turnstile}}
		{{^turnstile}}
			&lt;h1&gt;You are currently in the queue.&lt;/h1&gt;
			{{#waitTimeKnown}}
				&lt;h2&gt;Your estimated wait time is {{waitTimeFormatted}}.&lt;/h2&gt;
			{{/waitTimeKnown}}
			{{^waitTimeKnown}}
				&lt;h2&gt;Your estimated wait time is unknown.&lt;/h2&gt;
			{{/waitTimeKnown}}
		{{/turnstile}}
	&lt;/body&gt;
&lt;/html&gt;</code></pre>
	<p><sup><i>When using Infinite Queue (especially with managed challenges which may be interactive), you may want to tell users they will not be in the queue until they complete the challenge.</i></sup></p>
	<p>We embed a plain Turnstile challenge in the queuing page by passing the HTML to the queuing page template in a <code>turnstile</code> variable. The default queuing page template and any newly created custom templates include this variable already. If you have an existing custom HTML template and wish to enable the Turnstile integration, you will need to add <code>{{{turnstile}}}</code> somewhere in the template to tell Waiting Room where the widget should be placed. Waiting Room uses <a href="https://mustache.github.io"><u>Mustache</u></a> templates, so including raw HTML within your template without escaping requires three curly braces instead of two.</p>
	<figure class="kg-card kg-image-card">
		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/1SLLpx14dpaGITEsSxgDqX/eecd16a85e531de0b5325df5535e8ae8/image1.png" alt="" class="kg-image" width="1999" height="1000" loading="lazy">
	</figure>
	<p><sup><i>A managed Turnstile challenge on the default Waiting Room queuing page template</i></sup></p>
	<p>Once the challenge completes, fails, or times out, the page refreshes and passes the Turnstile token to <a href="https://blog.cloudflare.com/building-waiting-room-on-workers-and-durable-objects"><u>Waiting Room’s worker</u></a>. Next, we check in with <a href="https://developers.cloudflare.com/turnstile/get-started/server-side-validation"><u>Turnstile’s siteverify endpoint</u></a> to make sure the challenge was successful. From there, we report the outcome to the Waiting Room’s analytics and optionally send failed traffic (bots) to an infinite queue.</p>
	<p>The infinite queue itself is designed to be as close to normal queuing as possible. When a bot is sent to the infinite queue, we issue it a cookie which looks like a normal waiting room cookie. Inside the cookie’s encryption though, we have a boolean flag that tells our worker to send the bot’s requests to the infinite queue. When we see that flag, we skip all the normal queuing logic and just render a queuing page.</p>
	<p>That queuing page shows a fake estimated time remaining. It’s based on an asymptotic curve which appears to decrease linearly from the start. As time goes on, the curve gets flatter (and progress through the “queue” gets slower), so the estimated time remaining never quite reaches 0.</p>
	<figure class="kg-card kg-image-card">
		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/1J2U58CHRruMQ5LTkRo0fQ/8e7116eae5ba9fdecc6ac6cf404984ea/image5.png" alt="" class="kg-image" width="1999" height="801" loading="lazy">
	</figure>
	<p><sup><i>This graph is an approximation of the time remaining (y-axis, minutes) that bots will see, compared to the amount of time they’ve waited in the infinite queue (x-axis, minutes).</i></sup></p>
	<p>We reuse much of the same code for rendering the queuing page for the infinite queue and the normal queue. We do this to reduce the amount of signal bots may have that they are in the infinite queue rather than the normal queue.</p>
	<pre class="language-JavaScript"><code class="language-JavaScript">let cookie
if (query['cf_wr_turnstile']) {
    const turnstileToken = query['cf_wr_turnstile']
    const tokenOk = await siteverify(turnstileToken)
    if (tokenOk) {
        analytics.turnstileSuccesses++
        cookie = newCookie()
    } else {
        analytics.turnstileFailures++
        cookie = { infiniteQueuing: true }
    }
    response.headers['Set-Cookie'] = encryptCookie(cookie)
}
if (!cookie) {
    cookie = decryptCookie(headers['Cookie'])
}
if (!cookie) {
    analytics.turnstileChallenges++
    return await queuingPage(await estimateTimeRemaining(), { turnstileChallenge: true })
} else if (cookie.infiniteQueuing) {
    analytics.infiniteQueueRequests++
    return await queuingPage(fakeTimeRemaining())
} else if (cookie.accepted) {
    return await sendToOrigin()
} else {
    // run Waiting Room's distributed queuing logic to check whether
    // this user has made it to the front of the queue, but only after
    // the user has completed a Turnstile challenge and isn't in the
    // fake infinite queue
    const { letThrough, timeRemaining } = calculateQueuing(cookie)
    if (letThrough) {
        cookie.accepted = true
        response.headers['Set-Cookie'] = encryptCookie(cookie)
        return await sendToOrigin()
    } else {
        return await queuingPage(timeRemaining)
    }
}</code></pre>
	<p><sup><i>Approximate psuedocode for how we handle incoming requests when infinite queue is enabled in the Waiting Room worker</i></sup></p>
	<p>Thanks to the versatility of Turnstile, we only needed to rely on public Turnstile APIs to build this integration.</p>
	<p>Adding Turnstile to Waiting Room is a proactive step in managing traffic that directly contributes to a smoother, faster experience for end users. Building on that efficiency, let’s dive into how you can add an additional layer of control to increase throughput and minimize wait times for your customers.</p>
	<div class="flex anchor relative">
		<h3 id="further-improve-wait-times-using-session-revocation">Further improve wait times using session revocation</h3>
		<a href="https://blog.cloudflare.com/#further-improve-wait-times-using-session-revocation" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>We have talked extensively in a previous <a href="https://blog.cloudflare.com/building-waiting-room-on-workers-and-durable-objects/#how-does-the-waiting-room-work"><u>blog post</u></a> about how we queue users with respect to the current active users on the application and the defined limits, and, in the same <a href="https://blog.cloudflare.com/building-waiting-room-on-workers-and-durable-objects/#waiting-room-state"><u>blog post</u></a>, what state and calculations we use to determine the amount of total active users. Here is a quick summary for those who have not read that post:</p>
	<p>When a user navigates to a page behind a waiting room, they receive a <a href="https://developers.cloudflare.com/waiting-room/reference/waiting-room-cookie"><u>cookie</u></a> and are associated with a time period called a bucket. We use these buckets to track the number of users either waiting in the queue or accessing the application for that specific time period. Whenever a user makes a request, we move their session from their previous bucket to the latest bucket. Once a bucket is older than the configured session duration, we know that those user sessions are no longer valid (expired) and we can clean up those values. Thus, that user session expires, and new slots are opened for the next users to enter the application.</p>
	<p>These buckets are aggregated at Cloudflare data centers and then globally via the internal state of the waiting room, which is structured as multiple <a href="https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type"><u>CRDT</u></a> counters and registers. This allows us to merge the distributed state of the waiting room stored in multiple data centers as a single global state without conflicts.</p>
	<p>To calculate the total active users on an application, we first merge the state from all data centers. Then, we sum the active users for all the buckets where a session can still be active.</p>
	<figure class="kg-card kg-image-card">
		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/47yTgIvnWdYEcoOSoGPO8E/2989c82fcecd31ec22eb1384b0ff9e15/image7.png" alt="" class="kg-image" width="1632" height="1084" loading="lazy">
	</figure>
	<p>Because the Waiting Room runs per user request, we do not explicitly know when a user has stopped accessing the application, and instead we only stop receiving requests from them. So, we must consider their session active and as a contributor to the total active users count until it is older than the session duration limit. For waiting rooms that have a high session duration value configured, a user might navigate to the site for a small duration of time but contribute to the total active users count for up to the configured session duration even after they have stopped accessing the application. This can cause decreased throughput and longer wait times for users in the queue.&nbsp;</p>
	<div class="flex anchor relative">
		<h3 id="introducing-session-revocation">Introducing Session Revocation&nbsp;</h3>
		<a href="https://blog.cloudflare.com/#introducing-session-revocation" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>With the Session Revocation feature, we now allow origins to return a command to the waiting room via an HTTP header (<code>Cf-Waiting-Room-Command</code>) to notify the Waiting Room to revoke the user session associated with the current response. This command removes the current user’s session and decreases the number of total active users for the bucket the session was last tracked in. This allows origins to terminate a user’s session early without needing to wait for the session to expire naturally.</p>
	<figure class="kg-card kg-image-card">
		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/2THxw5YatXjjZ4GxTP793n/0536e1d0eb3166c94ccfb6c7dce4148a/image4.png" alt="" class="kg-image" width="750" height="499" loading="lazy">
	</figure>
	<p>This can improve the throughput of waiting rooms in front of applications which have a dynamic user flow where the session duration is set very high to account for users who send infrequent requests to the application.</p>
	<p>To set up session revocation in your waiting room, in the user session settings section in the configuration, check the “Allow session termination via origin commands” box. You must also configure your origin to return a session revocation HTTP header (<code>Cf-Waiting-Room-Command: revoke</code>) on the response when you want the session associated with that response to be revoked. For more information on how to do this, refer to our <a href="https://developers.cloudflare.com/waiting-room/how-to/control-user-session/#revoke-a-users-session-using-origin-commands"><u>developer documentation</u></a>.&nbsp;</p>
	<figure class="kg-card kg-image-card">
		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/4XXqREJAf1FwrDAFSUovJs/53cb8bd410647046b05ad6b8b6f9f277/image6.png" alt="" class="kg-image" width="804" height="332" loading="lazy">
	</figure>
	<p><sup><i>Enable session revocation in the user session settings configuration</i></sup></p>
	<p>In Waiting Room Analytics, you can view the number of sessions revoked per minute. The <code>sessionsRevoked</code><b> </b>field is the count of how many sessions were revoked in that minute in the <a href="https://developers.cloudflare.com/analytics/graphql-api"><u>analytics GraphQL API</u></a>.&nbsp;&nbsp;</p>
	<p>In summary, Waiting Room Turnstile Integration and Session Revocation work together to enhance both security and user experience. The addition of a Turnstile challenge in the Waiting Room helps identify and block bots, ensuring that legitimate users don’t face unnecessary delays. Meanwhile, the Session Revocation feature optimizes resource usage by allowing you to end user sessions after key actions, like completing a purchase, freeing up space for other users. </p>
	<p>Together, these features successfully increase throughput and reduce wait times, providing a faster, more efficient experience for your customers. For more information on these features, <a href="https://developers.cloudflare.com/waiting-room"><u>check out our developer documentation</u></a>.&nbsp;</p>
</div>